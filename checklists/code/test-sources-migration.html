<!DOCTYPE html>
<html>
<head>
    <title>Sources Migration Test</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/menu.css">
</head>
<body>
    <div style="padding: 20px;">
        <h1>Sources Migration Test</h1>
        
        <div style="margin-bottom: 20px;">
            <button id="test-cosucra" class="primary-btn">Load Cosucra1.json</button>
            <button id="test-ddv" class="secondary-btn">Load DDV.data.json</button>
            <button id="clear-results" class="secondary-btn">Clear Results</button>
        </div>

        <div id="test-results" style="margin-top: 20px;"></div>
        
        <div style="margin-top: 20px;">
            <h3>Sources Data:</h3>
            <pre id="sources-data" style="background: #f5f5f5; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto;"></pre>
        </div>
        
        <div style="margin-top: 20px;">
            <h3>Legacy Data (for comparison):</h3>
            <pre id="legacy-data" style="background: #f0f0f0; padding: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto;"></pre>
        </div>
    </div>

    <script type="module">
        import { loadChecklist, fetchRemoteChecklist } from './js/data.js';
        import { sharedState } from './js/constants.js';
        import { validateFieldDefinitions } from './js/data-fields.js';

        // Mock notification function
        window.showNotification = (type, message) => {
            const results = document.getElementById('test-results');
            const div = document.createElement('div');
            div.style.cssText = `
                padding: 10px; 
                margin: 10px 0; 
                border-radius: 4px; 
                background: ${type === 'error' ? '#fee' : type === 'success' ? '#efe' : '#eef'}; 
                color: ${type === 'error' ? '#c33' : type === 'success' ? '#363' : '#333'};
                border: 1px solid ${type === 'error' ? '#faa' : type === 'success' ? '#afa' : '#aaf'};
            `;
            div.textContent = `[${type.toUpperCase()}] ${message}`;
            results.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
        };

        // Function to update the sources data display
        function updateSourcesDisplay(data) {
            const sourcesData = document.getElementById('sources-data');
            const legacyData = document.getElementById('legacy-data');
            
            if (data.sources) {
                sourcesData.textContent = JSON.stringify(data.sources, null, 2);
            } else {
                sourcesData.textContent = 'No sources structure found';
            }
            
            // Show legacy data for comparison
            const legacy = {
                collaborators: data.collaborators || null,
                unitChoices: data.unitChoices || null
            };
            legacyData.textContent = JSON.stringify(legacy, null, 2);
        }

        // Function to validate sources structure
        function validateSources(data) {
            const results = [];
            
            // Check sources structure exists
            if (!data.sources) {
                results.push('❌ Missing sources structure');
            } else {
                results.push('✅ Sources structure exists');
                
                // Check unitChoices
                if (!data.sources.unitChoices) {
                    results.push('❌ Missing sources.unitChoices');
                } else if (!Array.isArray(data.sources.unitChoices)) {
                    results.push('❌ sources.unitChoices is not an array');
                } else {
                    results.push(`✅ sources.unitChoices has ${data.sources.unitChoices.length} entries`);
                }
                
                // Check collaborators
                if (!data.sources.collaborators) {
                    results.push('❌ Missing sources.collaborators');
                } else if (!Array.isArray(data.sources.collaborators)) {
                    results.push('❌ sources.collaborators is not an array');
                } else {
                    results.push(`✅ sources.collaborators has ${data.sources.collaborators.length} entries`);
                }
                
                // Check backward compatibility
                if (data.collaborators && JSON.stringify(data.collaborators) === JSON.stringify(data.sources.collaborators)) {
                    results.push('✅ Backward compatibility: root collaborators matches sources.collaborators');
                } else {
                    results.push('⚠️ Backward compatibility: root collaborators does not match sources.collaborators');
                }
                
                if (data.unitChoices && JSON.stringify(data.unitChoices) === JSON.stringify(data.sources.unitChoices)) {
                    results.push('✅ Backward compatibility: root unitChoices matches sources.unitChoices');
                } else {
                    results.push('⚠️ Backward compatibility: root unitChoices does not match sources.unitChoices');
                }
            }
            
            return results;
        }

        // Test loading with migration
        async function testMigration(filepath) {
            showNotification('info', `Loading ${filepath}...`);
            
            try {
                // First, load the raw data to show original structure
                const rawData = await fetchRemoteChecklist(filepath);
                showNotification('info', `Raw data loaded - has sources: ${!!rawData.sources}`);
                
                // Now load through the migration system
                await loadChecklist(filepath);
                
                // Validate the migrated structure
                const validationResults = validateSources(sharedState.checklistData);
                validationResults.forEach(result => {
                    const type = result.startsWith('✅') ? 'success' : 
                                result.startsWith('⚠️') ? 'warning' : 'error';
                    showNotification(type, result);
                });
                
                // Update display
                updateSourcesDisplay(sharedState.checklistData);
                
                // Test field validation
                try {
                    validateFieldDefinitions(sharedState.checklistData);
                    showNotification('success', 'Field validation passed');
                } catch (error) {
                    showNotification('error', `Field validation failed: ${error.message}`);
                }
                
                showNotification('success', `Migration test completed for ${filepath}`);
                
            } catch (error) {
                showNotification('error', `Test failed: ${error.message}`);
                console.error('Migration test error:', error);
            }
        }

        // Event listeners
        document.getElementById('test-cosucra').addEventListener('click', () => {
            testMigration('checklists/2025_06_20_@_15-11-58 Cosucra1.json');
        });

        document.getElementById('test-ddv').addEventListener('click', () => {
            testMigration('checklists/2025_04_27_@_16-13-33_DDV.data.json');
        });

        document.getElementById('clear-results').addEventListener('click', () => {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('sources-data').textContent = '';
            document.getElementById('legacy-data').textContent = '';
        });

        // Initialize
        showNotification('info', 'Sources migration test ready');
    </script>
</body>
</html>
